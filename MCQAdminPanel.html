<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MCQ Admin — Build & Export Quiz (fixed)</title>
<style>
  :root{--bg:#f7f8fb;--card:#fff;--muted:#666;--accent:#2b6ef6;--danger:#e15347;--ok:#36a06b}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,"Noto Sans",sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .badge{background:#eef4ff;color:#1038a9;padding:6px 10px;border-radius:999px;font-weight:700}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(12,20,40,0.06);margin-bottom:12px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"], textarea, select {width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9f2}
  textarea{min-height:56px;resize:vertical}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
  .danger{background:var(--danger)}
  .ok{background:var(--ok)}
  .small{padding:6px 8px;font-size:13px}
  .qitem{border:1px dashed #e6e9f2;padding:10px;border-radius:8px;margin-bottom:8px}
  .opts{margin-top:8px}
  .opt{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .opt input[type="text"]{flex:1}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .flex{display:flex;gap:8px}
  .center{display:flex;align-items:center;gap:8px}
  .grab{cursor:grab}
  footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
  @media (max-width:720px){
    .row{flex-direction:column}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>MCQ Admin — Build & Export Quiz</h1>
    <div class="center">
      <div class="muted">Generated quiz: simple style • filename asked</div>
    </div>
  </header>

  <div class="card">
    <div class="row" style="align-items:center">
      <div style="flex:1 1 240px">
        <label class="muted">Quiz title</label>
        <input id="quizTitle" placeholder="E.g., Algebra Test — Class 10" />
      </div>
      <div style="flex:0 0 220px">
        <label class="muted">Language hint (optional)</label>
        <input id="quizLang" placeholder="E.g., Bangla / English" />
      </div>
      <div style="flex:0 0 160px;align-self:end">
        <div class="controls">
          <button id="addQbtn" class="small">+ Add Question</button>
          <button id="clearAll" class="small danger">Delete All</button>
        </div>
      </div>
    </div>
    <div style="margin-top:8px" class="muted">Each question can have any number of options. Mark one option as correct. When ready, scroll to bottom and press <strong>Create Quiz File</strong>.</div>
  </div>

  <div id="qContainer"></div>

  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div class="muted">When you press <strong>Create Quiz File</strong>, you will be asked for filename. The file will be downloaded and is fully standalone.</div>
      <div class="flex">
        <button id="exportBtn">Create Quiz File</button>
        <button id="sampleBtn" class="small">Insert Sample Qs</button>
        <button id="downloadJson" class="small">Export JSON</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none" />
        <button id="importJson" class="small">Import JSON</button>
      </div>
    </div>
  </div>

  <footer>Works offline. Generated quiz shows all selected questions on one page and uses a total exam timer.</footer>
</div>

<script>
/*
  Fixed admin script:
  - run after DOMContentLoaded
  - robust event binding
  - error guard with console output
*/
document.addEventListener('DOMContentLoaded', () => {
  try {
    // state
    let questions = [];

    // helpers
    const el = id => document.getElementById(id);
    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
    function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // create an empty question with 4 default options
    function newQuestion(){
      return {
        id: uid(),
        text: '',
        opts: [
          {id: uid(), text: ''},
          {id: uid(), text: ''},
          {id: uid(), text: ''},
          {id: uid(), text: ''}
        ],
        correctId: null
      };
    }

    // render the full list
    function renderAll(){
      const container = el('qContainer');
      container.innerHTML = '';
      if(questions.length === 0){
        container.innerHTML = '<div class="card muted">No questions yet. Click "Add Question" to start.</div>';
        return;
      }
      questions.forEach((q, idx) => {
        container.appendChild(renderQuestionCard(q, idx));
      });
    }

    // render a single question card
    function renderQuestionCard(q, idx){
      const card = document.createElement('div');
      card.className = 'card qitem';
      card.dataset.id = q.id;

      const header = document.createElement('div');
      header.style.display='flex';
      header.style.justifyContent='space-between';
      header.style.alignItems='center';
      header.innerHTML = `<div style="font-weight:700">Q${idx+1}</div>`;
      card.appendChild(header);

      const body = document.createElement('div');
      body.style.marginTop='8px';
      body.innerHTML = `
        <label class="muted">Question text</label>
        <textarea class="qtext" placeholder="Type question here...">${escapeHtml(q.text)}</textarea>
        <div class="opts"></div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="addOpt small">+ Option</button>
          <button class="removeQ small danger">Delete Question</button>
          <div style="flex:1"></div>
          <label class="muted small">Mark correct</label>
        </div>
      `;
      card.appendChild(body);

      const optsDiv = body.querySelector('.opts');

      // populate options
      q.opts.forEach(opt => {
        optsDiv.appendChild(renderOptionRow(opt, q));
      });

      // event listeners for question controls
      const qtext = body.querySelector('.qtext');
      qtext.addEventListener('input', (e)=> q.text = e.target.value);

      const addOptBtn = body.querySelector('.addOpt');
      addOptBtn.addEventListener('click', ()=> {
        const newOpt = {id: uid(), text: ''};
        q.opts.push(newOpt);
        optsDiv.appendChild(renderOptionRow(newOpt, q));
      });

      const removeQBtn = body.querySelector('.removeQ');
      removeQBtn.addEventListener('click', ()=> {
        if(!confirm('Delete this question?')) return;
        questions = questions.filter(x=>x.id !== q.id);
        renderAll();
      });

      return card;
    }

    // render single option row
    function renderOptionRow(opt, q){
      const row = document.createElement('div');
      row.className = 'opt';
      row.dataset.optid = opt.id;
      row.innerHTML = `
        <input type="radio" name="correct-${q.id}" ${q.correctId === opt.id ? 'checked' : ''} />
        <input type="text" class="opttext" placeholder="Option text" value="${escapeHtml(opt.text)}" />
        <button class="small removeOpt danger">✕</button>
      `;
      const radio = row.querySelector('input[type="radio"]');
      const optInput = row.querySelector('.opttext');
      const removeBtn = row.querySelector('.removeOpt');

      radio.addEventListener('change', ()=> {
        q.correctId = opt.id;
      });

      optInput.addEventListener('input', (e)=> {
        opt.text = e.target.value;
      });

      removeBtn.addEventListener('click', ()=> {
        if(!confirm('Remove this option?')) return;
        q.opts = q.opts.filter(o => o.id !== opt.id);
        if(q.correctId === opt.id) q.correctId = null;
        row.remove();
      });

      return row;
    }

    // wire buttons
    el('addQbtn').addEventListener('click', ()=> {
      const q = newQuestion();
      questions.push(q);
      renderAll();
      // scroll to bottom for small screens
      setTimeout(()=> window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 80);
    });

    el('clearAll').addEventListener('click', ()=> {
      if(!confirm('Delete ALL questions?')) return;
      questions = [];
      renderAll();
    });

    el('sampleBtn').addEventListener('click', ()=> {
      questions = [
        { id: uid(), text: 'What is 2 + 2?', opts: [{id:uid(),text:'3'},{id:uid(),text:'4'},{id:uid(),text:'5'}], correctId: null },
        { id: uid(), text: 'Capital of Bangladesh?', opts: [{id:uid(),text:'Chittagong'},{id:uid(),text:'Dhaka'},{id:uid(),text:'Khulna'}], correctId: null }
      ];
      renderAll();
    });

    // Export JSON
    el('downloadJson').addEventListener('click', ()=> {
      const payload = { title: el('quizTitle').value||'', lang: el('quizLang').value||'', questions };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mcq_export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Import JSON
    el('importJson').addEventListener('click', ()=> el('fileInput').click());
    el('fileInput').addEventListener('change', (ev)=> {
      const f = ev.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        try {
          const data = JSON.parse(r.result);
          if(!data || !Array.isArray(data.questions)) throw new Error('Invalid file: missing questions array');
          questions = data.questions.map(q=> ({
            id: q.id || uid(),
            text: q.text || '',
            opts: Array.isArray(q.opts) ? q.opts.map(o=> ({ id: o.id || uid(), text: o.text || '' })) : [],
            correctId: q.correctId || null
          }));
          el('quizTitle').value = data.title || '';
          el('quizLang').value = data.lang || '';
          renderAll();
          alert('Import complete.');
        } catch(err){
          console.error(err);
          alert('Import failed: ' + (err.message||err));
        }
      };
      r.readAsText(f,'utf-8');
    });

    // Export to standalone quiz.html
    el('exportBtn').addEventListener('click', ()=> {
      try {
        if(questions.length === 0){ alert('Add at least one question.'); return; }
        // basic validation & ensure correct option exists
        for(const q of questions){
          if(!q.text || q.text.trim()===''){ alert('One or more questions are empty. Fill question text.'); return; }
          if(!q.opts || q.opts.length === 0){ alert('Each question must have at least one option.'); return; }
          if(!q.correctId){
            // set first option as correct by default
            q.correctId = q.opts[0].id;
          }
        }

        const filename = prompt('Enter filename for the quiz (include .html):', 'quiz.html');
        if(!filename) return;

        const payload = {
          title: el('quizTitle').value || '',
          lang: el('quizLang').value || '',
          questions
        };

        const quizHtml = generateQuizHtml(payload);
        const blob = new Blob([quizHtml], {type:'text/html;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      } catch(err){
        console.error(err);
        alert('Export failed: ' + (err.message||err));
      }
    });

    // generate quiz html (same as before but moved into this scope)
    function generateQuizHtml(payload){
      const dataStr = JSON.stringify(payload).replace(/<\/script>/gi, '<\\/script>');
      return `<!doctype html>
<html lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><title>${escapeHtml(payload.title||'MCQ Quiz')}</title>
<style>:root{--bg:#ffffff;--muted:#666;--accent:#2b6ef6;--ok:#36a06b;--danger:#e15347}body{margin:0;font-family:system-ui,Segoe UI,Roboto,"Noto Sans",sans-serif;background:#f6f7fb;color:#111}.wrap{max-width:980px;margin:12px auto;padding:18px}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}h1{font-size:18px;margin:0}.muted{color:var(--muted)}.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}select,input[type="number"]{padding:8px;border-radius:8px;border:1px solid #e6e9f2}button{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}.card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(12,20,40,0.06);margin-bottom:12px}.qcard{padding:12px;border-radius:8px;border:1px solid #eef1fb;margin-bottom:12px;background:#fff}.option{padding:8px;border-radius:6px;margin:6px 0;cursor:pointer;border:1px solid transparent}.option:hover{background:#f6f8ff}.option.selected{outline:2px solid #cfe0ff}.option.correct{background: #e6fbef;border-color: #36a06b}.option.wrong{background:#fdecea;border-color:#e15347}#timer{position:fixed;right:12px;top:12px;background:#0f172a;color:white;padding:8px 10px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.2)}.result{padding:12px;border-radius:8px;margin-top:12px}.summary{display:flex;gap:12px;flex-wrap:wrap}.small{font-size:13px}footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}@media (max-width:720px){ .wrap{padding:12px} }</style></head><body>
<div id="timer" style="display:none">Time left: <span id="timeVal">0:00</span></div>
<div class="wrap">
  <header>
    <div>
      <h1>${escapeHtml(payload.title||'MCQ Quiz')}</h1>
      <div class="muted">${escapeHtml(payload.lang||'')}</div>
    </div>
  </header>

  <div id="startPanel" class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div>
        <label class="muted">Number of MCQs</label><br/>
        <select id="qty">
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
          <option value="all">All</option>
        </select>
      </div>
      <div>
        <label class="muted">Timer (seconds)</label><br/>
        <select id="timerSel">
          <option value="30">30 sec</option>
          <option value="60" selected>1 min</option>
          <option value="120">2 min</option>
          <option value="180">3 min</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div id="customWrap" style="display:none">
        <label class="muted">Custom (sec)</label><br/>
        <input id="customSec" type="number" min="10" step="5" style="width:120px" />
      </div>
      <div style="margin-left:auto">
        <button id="startBtn">Start Exam</button>
      </div>
    </div>
    <div style="margin-top:8px" class="muted small">Selected questions will appear all at once on a single page. Timer is for the whole exam.</div>
  </div>

  <div id="examArea" style="display:none"></div>
  <div id="resultArea" style="display:none"></div>

  <footer>This file is standalone. No progress saved.</footer>
</div>

<script>
  const payload = ${dataStr};
  function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function shuffle(a){ const arr = a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

  const startPanel = document.getElementById('startPanel');
  const examArea = document.getElementById('examArea');
  const resultArea = document.getElementById('resultArea');
  const timerDiv = document.getElementById('timer');
  const timeVal = document.getElementById('timeVal');
  const qtyEl = document.getElementById('qty');
  const timerSel = document.getElementById('timerSel');
  const customWrap = document.getElementById('customWrap');
  const customSec = document.getElementById('customSec');

  timerSel.addEventListener('change', ()=> customWrap.style.display = (timerSel.value==='custom') ? 'block' : 'none');

  let chosenIds = [];
  let answers = {};
  let examTimer = null;
  let timeLeft = 0;

  function pickRandom(count){
    const pool = payload.questions.slice();
    if(count === 'all' || count >= pool.length) return pool.slice();
    const ids = pool.map(q=>q.id);
    let set = shuffle(ids).slice(0,count);
    try{
      const lastKey = 'last_set_quiz_'+(payload.title||'');
      const last = sessionStorage.getItem(lastKey);
      if(last){
        const lastArr = JSON.parse(last);
        let attempts = 0;
        while(JSON.stringify(set) === JSON.stringify(lastArr) && attempts < 25){
          set = shuffle(ids).slice(0,count);
          attempts++;
        }
      }
      sessionStorage.setItem(lastKey, JSON.stringify(set));
    }catch(e){}
    const map = {};
    pool.forEach(p=> map[p.id] = p);
    return set.map(id => map[id]).filter(Boolean);
  }

  document.getElementById('startBtn').addEventListener('click', ()=>{
    const qty = qtyEl.value;
    const count = (qty==='all') ? 'all' : Number(qty);
    let secs = (timerSel.value==='custom') ? (Number(customSec.value)||60) : Number(timerSel.value);
    if(secs <= 0) secs = 60;
    const picked = pickRandom(count);
    if(picked.length === 0){ alert('No questions in this quiz.'); return; }
    startExamWith(picked, secs);
  });

  function startExamWith(qList, seconds){
    answers = {};
    chosenIds = qList.map(q => q.id);
    startPanel.style.display = 'none';
    examArea.style.display = 'block';
    examArea.innerHTML = '';
    const topInfo = document.createElement('div');
    topInfo.className = 'card';
    topInfo.innerHTML = '<div class="muted">Questions: ' + qList.length + '</div><div style="margin-top:6px"><button id="submitBtn">Submit Exam</button></div>';
    examArea.appendChild(topInfo);

    qList.forEach((q, idx)=>{
      const card = document.createElement('div');
      card.className = 'qcard';
      card.innerHTML = '<div><strong>Q' + (idx+1) + '.</strong> ' + escapeHtml(q.text) + '</div>';
      const optsDiv = document.createElement('div');
      optsDiv.style.marginTop='8px';
      q.opts.forEach((opt, oi)=>{
        const op = document.createElement('div');
        op.className = 'option';
        op.tabIndex = 0;
        op.innerHTML = '<div>' + String.fromCharCode(65+oi) + '. ' + escapeHtml(opt.text||'') + '</div>';
        op.addEventListener('click', ()=> {
          answers[q.id] = oi;
          Array.from(optsDiv.children).forEach((c,ci)=> c.classList.toggle('selected', ci===oi));
        });
        op.addEventListener('keydown', (e)=> { if(e.key==='Enter') op.click(); });
        optsDiv.appendChild(op);
      });
      card.appendChild(optsDiv);
      examArea.appendChild(card);
    });

    document.getElementById('submitBtn').addEventListener('click', ()=> {
      if(!confirm('Submit answers now?')) return;
      stopTimerAndFinalize();
    });

    timeLeft = seconds;
    timerDiv.style.display = 'block';
    renderTime();
    if(examTimer) clearInterval(examTimer);
    examTimer = setInterval(()=>{
      timeLeft--;
      renderTime();
      if(timeLeft <= 0){
        clearInterval(examTimer);
        finalize();
      }
    }, 1000);
  }

  function renderTime(){
    const mm = Math.floor(timeLeft/60), ss = timeLeft%60;
    timeVal.textContent = mm + ':' + (ss<10? '0'+ss : ss);
  }

  function stopTimerAndFinalize(){
    if(examTimer) clearInterval(examTimer);
    finalize();
  }

  function finalize(){
    const qMap = {};
    (payload.questions||[]).forEach(q=> qMap[q.id] = q);
    let passed = 0, failed = 0;
    const cards = document.querySelectorAll('.qcard');
    cards.forEach((card, idx)=>{
      const qid = chosenIds[idx];
      const q = qMap[qid];
      if(!q) return;
      const optsNodes = card.querySelectorAll('.option');
      optsNodes.forEach((node, oi)=>{
        if(q.opts[oi] && q.opts[oi].id === q.correctId){
          node.classList.add('correct');
        }
        if(typeof answers[qid] !== 'undefined' && answers[qid] === oi && q.opts[oi].id !== q.correctId){
          node.classList.add('wrong');
        }
      });
      const isPass = (typeof answers[qid] !== 'undefined' && q.opts[answers[qid]] && q.opts[answers[qid]].id === q.correctId);
      if(isPass) passed++; else failed++;
    });

    resultArea.style.display = 'block';
    resultArea.innerHTML = '';
    const resCard = document.createElement('div');
    resCard.className = 'card result';
    resCard.innerHTML = '<h3>Result</h3><div class="summary"><div><strong>Passed:</strong> <span style="padding:6px;border-radius:6px;background:var(--ok);color:#fff">'+passed+'</span></div><div><strong>Failed:</strong> <span style="padding:6px;border-radius:6px;background:var(--danger);color:#fff">'+failed+'</span></div><div><strong>Total:</strong> '+(passed+failed)+'</div></div><div style="margin-top:12px"><button id="retry">Take Another Exam</button> <button id="exportAnswers">Export Answers (JSON)</button></div>';
    resultArea.appendChild(resCard);

    document.getElementById('retry').addEventListener('click', ()=> {
      resultArea.style.display = 'none';
      examArea.style.display = 'none';
      startPanel.style.display = 'block';
      timerDiv.style.display = 'none';
      answers = {};
      chosenIds = [];
    });

    document.getElementById('exportAnswers').addEventListener('click', ()=>{
      const out = { title: payload.title||'', date: new Date().toISOString(), answers, chosen: chosenIds };
      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'answers.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }
<\/script></body></html>`;
    }

    // initial render
    renderAll();

  } catch (err) {
    console.error('Admin script error:', err);
    alert('Something went wrong initializing the admin panel. Open console for details.');
  }
});
</script>
</body>
</html>
